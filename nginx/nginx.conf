worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # ── Upstream pools (one per backend service) ─────────────────────────
    # Services with deploy.replicas > 1 benefit from round-robin here.

    upstream requirements {
        server requirements:8000;
    }
    upstream testcases {
        server testcases:8000;
    }
    upstream generator {
        server generator:8000;
    }
    upstream releases {
        server releases:8000;
    }
    upstream executions {
        server executions:8000;
    }
    upstream automations {
        server automations:8000;
    }
    upstream testcase-migration {
        server testcase-migration:8000;
    }
    upstream toabrkia {
        server toabrkia:8000;
    }
    upstream git {
        server git:8000;
    }

    # ── Shared proxy settings ────────────────────────────────────────────
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    server {
        listen 80;
        server_name _;

        # ── API routes ───────────────────────────────────────────────────
        location /api/requirements/ {
            proxy_pass http://requirements/;
        }
        location /api/testcases/ {
            proxy_pass http://testcases/;
        }
        location /api/generator/ {
            proxy_pass http://generator/;
        }
        location /api/releases/ {
            proxy_pass http://releases/;
        }
        location /api/executions/ {
            proxy_pass http://executions/;
        }
        location /api/automations/ {
            proxy_pass http://automations/;
        }
        location /api/testcase-migration/ {
            proxy_pass http://testcase-migration/;
        }
        location /api/toabrkia/ {
            proxy_pass http://toabrkia/;
        }
        location /api/git/ {
            proxy_pass http://git/;
        }

        # ── Frontend (default) ───────────────────────────────────────────
        location / {
            proxy_pass http://frontend:5173;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
